<!-- Страница "О сайте" с комментариями пользователей -->
<div class="page-container">
  <section class="flashy-section">
    <h1 class="flashy-section__heading">О сайте "САМЫЕ КРУТЫЕ ЦИТАТЫ"</h1>
    <p class="flashy-section__paragraph">
      Наш сайт создан для всех, кто ценит мудрость, юмор и вдохновение,
      заключенные в коротких, но емких высказываниях великих людей и не только.
    </p>
  </section>

  {{#if stats}}
    <section class="general-section">
      <h2 class="section-title">Статистика сайта</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="stat-totalQuotes">{{stats.totalQuotes}}</div>
          <div class="stat-label">Цитат</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-totalAuthors">{{stats.totalAuthors}}</div>
          <div class="stat-label">Авторов</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-totalUsers">{{stats.totalUsers}}</div>
          <div class="stat-label">Пользователей</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-totalComments">{{stats.totalComments}}</div>
          <div class="stat-label">Комментариев</div>
        </div>
      </div>
    </section>
  {{/if}}

  <!-- Уведомления -->
  <div id="notifications"></div>

  <section class="general-section">
    <h2 class="section-title">Наша миссия</h2>
    <div class="content-block">
      <p>
        Мы стремимся собрать самую обширную коллекцию цитат на русском языке,
        которая будет вдохновлять, мотивировать и заставлять задуматься.
        Каждая цитата на нашем сайте тщательно отобрана и проверена на подлинность.
      </p>
      <p>
        <strong>Что делает нас особенными:</strong>
      </p>
      <ul class="features-list">
        <li>- Тщательно отобранные цитаты высокого качества</li>
        <li>- Удобная система поиска и фильтрации</li>
        <li>- Активное сообщество любителей мудрых мыслей</li>
        <li>- Ежедневное пополнение коллекции</li>
        <li>- Уникальная подборка мемов для поднятия настроения</li>
      </ul>
    </div>
  </section>

  <section class="general-section">
    <h2 class="section-title">Об авторе</h2>
    <div class="author-info">
      <p>
        <strong>Создатель сайта:</strong> Иващенко Егор Сергеевич, студент группы M3314<br>
        <strong>Проект:</strong> Лабораторные работы по Web-разработке 2024-2025<br>
        <strong>Контакты:</strong> <a href="mailto:admin@quotes.site">admin@quotes.site</a>
      </p>
    </div>
  </section>

  <!-- Форма добавления комментария -->
  <section class="general-section">
    <h2 class="section-title">Оставить отзыв о сайте</h2>

    {{#if commentSuccess}}
      <div class="alert alert-success">
        Спасибо за ваш отзыв!
      </div>
    {{/if}}

    {{#if commentError}}
      <div class="alert alert-error">
        Произошла ошибка при отправке комментария.
      </div>
    {{/if}}

    <div class="comment-form-container">
      <form action="/comments/create" method="POST" class="comment-form">
        <div class="form-group">
          <label for="commentAuthor" class="required">Ваше имя:</label>
          <input type="text"
                 id="commentAuthor"
                 name="author"
                 required
                 placeholder="Как вас зовут?"
                 maxlength="50"
                 {{#if username}}value="{{username}}"{{/if}}
            {{#if isAuthenticated}}readonly{{/if}}
                 class="form-input">
        </div>

        <div class="form-group">
          <label for="commentText" class="required">Ваш комментарий:</label>
          <textarea id="commentText"
                    name="text"
                    rows="4"
                    required
                    placeholder="Поделитесь вашим мнением о сайте..."
                    maxlength="300"
                    class="form-textarea"></textarea>
          <small class="form-hint">Максимум 300 символов</small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            Отправить комментарий
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- Список комментариев -->
  <section class="general-section">
    <h2 class="section-title">Отзывы пользователей ({{commentsCount}})</h2>

    <div class="comments-container">
      {{#if comments}}
        {{#each comments}}
          {{> commentCard this canDelete=(or ../isAuthenticated (eq this.author ../username))}}
        {{/each}}

        <!-- Пагинация для комментариев -->
        {{#if hasPagination}}
          <div class="pagination">
            {{#if hasPrevPage}}
              <a href="/about?page={{prevPage}}" class="pagination__link">← Предыдущие</a>
            {{/if}}

            <span class="pagination__info">
              Страница {{currentPageNumber}} из {{totalPages}}
            </span>

            {{#if hasNextPage}}
              <a href="/about?page={{nextPage}}" class="pagination__link">Следующие →</a>
            {{/if}}
          </div>
        {{/if}}
      {{else}}
        <div class="empty-state">
          <p>Пока нет ни одного отзыва. Будьте первым!</p>
        </div>
      {{/if}}
    </div>
  </section>
</div>

<style>
  /* Стили для уведомлений */
  #notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
  }

  .notification {
    background: #d4edda;
    color: #155724;
    padding: 15px 20px;
    border-radius: 4px;
    margin-bottom: 10px;
    border: 1px solid #c3e6cb;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideIn 0.3s ease forwards;
    min-width: 250px;
    transform: translateX(0);
    opacity: 1;
  }

  .notification.error {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  .notification.fade-out {
    animation: slideOut 0.3s ease;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .stat-card {
    transition: transform 0.2s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
  }
</style>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const eventSource = new EventSource('/about/stats-events');

    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);

        if (data.type === 'stats_update') {
          // Обновляем статистику
          document.getElementById('stat-totalQuotes').textContent = data.stats.totalQuotes;
          document.getElementById('stat-totalAuthors').textContent = data.stats.totalAuthors;
          document.getElementById('stat-totalUsers').textContent = data.stats.totalUsers;
          document.getElementById('stat-totalComments').textContent = data.stats.totalComments;

          // Показываем уведомление
          showNotification('Статистика обновлена: ' + new Date().toLocaleTimeString('ru-RU'));
        }
      } catch (error) {
        console.error('Ошибка обработки SSE:', error);
      }
    };

    eventSource.onerror = function(error) {
      console.error('Ошибка SSE соединения:', error);
      showNotification('Ошибка соединения с сервером', 'error');
    };
  });

  function showNotification(message, type = 'success') {
    const container = document.getElementById('notifications');

    if (!container) {
      console.error('Элемент notifications не найден');
      return;
    }

    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;

    if (type === 'error') {
      notification.classList.add('error');
    }

    container.appendChild(notification);

    // Ждем завершения анимации появления, затем отсчитываем время показа
    setTimeout(() => {
      // Убираем уведомление через 5 секунд ПОСЛЕ появления
      setTimeout(() => {
        // Добавляем класс для анимации исчезновения
        notification.classList.add('fade-out');

        // Удаляем элемент после завершения анимации
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 300); // Длительность анимации slideOut
      }, 5000); // Время показа: 5 секунд
    }, 300); // Ждем завершения анимации slideIn
  }
</script>